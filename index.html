<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zgłoszenie zdarzenia</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 1rem;
      margin: 0;
      background-color: #f8f9fa;
    }
    form {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
      color: #333;
    }
    label {
      display: block;
      margin-top: 1rem;
      color: #333;
      font-weight: 500;
    }
    input, select, textarea, datalist {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.25rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.75rem;
      font-size: 1rem;
      width: 100%;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background-color: #218838;
    }
    .hidden { display: none; }
    .loading {
      text-align: center;
      margin-top: 1rem;
    }
    .error {
      color: #dc3545;
      margin-top: 0.25rem;
      font-size: 0.875rem;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      text-align: center;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <form id="incidentForm">
    <h2>Zgłoszenie zdarzenia</h2>
    <div id="successMessage" class="success hidden">Zgłoszenie zostało wysłane pomyślnie!</div>

    <label>Miasto
      <input type="text" name="miasto" id="miasto" list="listaMiast" required>
      <datalist id="listaMiast"></datalist>
    </label>

    <label>Ulica
      <input type="text" name="ulica" id="ulica" list="listaUlic" required>
      <datalist id="listaUlic"></datalist>
    </label>

    <label>Nr domu / mieszkania
      <input type="text" name="numer" id="numer" required>
    </label>

    <label>Nazwa kateringu
      <select name="katering" id="katering" required>
        <option value="">-- Wybierz --</option>
      </select>
    </label>

    <label>Zdarzenie
      <select name="zdarzenie" id="zdarzenie" required>
        <option value="">-- Wybierz --</option>
        <option value="BRAK PACZKI">BRAK PACZKI</option>
        <option value="DODATKOWA PACZKA">DODATKOWA PACZKA</option>
        <option value="USZKODZENIE PACZKI">USZKODZENIE PACZKI</option>
        <option value="NIEDORECZENIE / BŁĘDNY ADRES">NIEDORECZENIE / BŁĘDNY ADRES</option>
      </select>
    </label>

    <div id="poleIlosc" class="hidden">
      <label>Ilość paczek
        <select name="ilosc" id="ilosc">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </label>
    </div>

    <div id="poleUszkodzenie" class="hidden">
      <label>Rodzaj uszkodzenia
        <select name="rodzaj_uszkodzenia" id="rodzaj_uszkodzenia">
          <option value="ROZSZCZELNIONY POJEMNIK">ROZSZCZELNIONY POJEMNIK</option>
          <option value="USZKODZONY POJEMNIK">USZKODZONY POJEMNIK</option>
        </select>
      </label>
      <label>Zdjęcia uszkodzeń (wymagane)
        <input type="file" name="zdjecia_uszkodzen" id="zdjecia_uszkodzen" accept="image/*" multiple>
      </label>
    </div>

    <div id="poleOpisZdjecia" class="hidden">
      <label>Opis zdarzenia
        <textarea name="opis" id="opis" rows="4"></textarea>
      </label>
      <label>Zdjęcia / Film
        <input type="file" name="zdjecia_filmu" id="zdjecia_filmu" accept="image/*,video/*" multiple>
      </label>
    </div>

    <button type="submit" id="submitBtn">Wyślij zgłoszenie</button>
    <div id="loadingIndicator" class="loading hidden">
      Wysyłanie zgłoszenia, proszę czekać...
    </div>
  </form>

  <script>
    // Załaduj listę kateringów z pliku JSON
    async function fetchKateringList() {
      try {
        const response = await fetch('cateringlist.json');
        const data = await response.json();
        
        // Załaduj kateringi
        const select = document.getElementById("katering");
        select.innerHTML = '<option value="">-- Wybierz --</option>';
        
        data.caterings.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });
        
        // Załaduj miasta do datalisty
        const datalistMiasta = document.getElementById("listaMiast");
        datalistMiasta.innerHTML = '';
        data.miasta.forEach(miasto => {
          const option = document.createElement('option');
          option.value = miasto;
          datalistMiasta.appendChild(option);
        });
        
        // Załaduj ulice do datalisty
        const datalistUlice = document.getElementById("listaUlic");
        datalistUlice.innerHTML = '';
        data.ulice.forEach(ulica => {
          const option = document.createElement('option');
          option.value = ulica;
          datalistUlice.appendChild(option);
        });
      } catch (error) {
        console.error("Błąd podczas ładowania listy kateringów:", error);
        alert("Nie udało się załadować listy kateringów. Odśwież stronę lub skontaktuj się z administratorem.");
      }
    }

    // Obsługa zmiany rodzaju zdarzenia
    document.getElementById("zdarzenie").addEventListener("change", function() {
      const val = this.value;
      document.getElementById("poleIlosc").classList.add("hidden");
      document.getElementById("poleUszkodzenie").classList.add("hidden");
      document.getElementById("poleOpisZdjecia").classList.add("hidden");
      
      // Resetuj wymagane pola
      document.getElementById("ilosc").removeAttribute("required");
      document.getElementById("rodzaj_uszkodzenia").removeAttribute("required");
      document.getElementById("zdjecia_uszkodzen").removeAttribute("required");
      document.getElementById("opis").removeAttribute("required");

      if (val === "BRAK PACZKI" || val === "DODATKOWA PACZKA") {
        document.getElementById("poleIlosc").classList.remove("hidden");
        document.getElementById("ilosc").setAttribute("required", "");
      } else if (val === "USZKODZENIE PACZKI") {
        document.getElementById("poleUszkodzenie").classList.remove("hidden");
        document.getElementById("rodzaj_uszkodzenia").setAttribute("required", "");
        document.getElementById("zdjecia_uszkodzen").setAttribute("required", "");
      } else if (val === "NIEDORECZENIE / BŁĘDNY ADRES") {
        document.getElementById("poleOpisZdjecia").classList.remove("hidden");
        document.getElementById("opis").setAttribute("required", "");
      }
    });

    // Obsługa wysłania formularza
    document.getElementById("incidentForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      // Walidacja formularza
      const zdarzenie = document.getElementById("zdarzenie").value;
      
      if (zdarzenie === "USZKODZENIE PACZKI") {
        const zdjecia = document.getElementById("zdjecia_uszkodzen").files;
        if (zdjecia.length === 0) {
          alert("Dla uszkodzonej paczki wymagane jest załączenie zdjęć!");
          return;
        }
      }
      
      if (zdarzenie === "NIEDORECZENIE / BŁĘDNY ADRES") {
        const opis = document.getElementById("opis").value.trim();
        if (opis === "") {
          alert("Dla niedoręczonej paczki wymagany jest opis!");
          return;
        }
      }
      
      // Pokaż wskaźnik ładowania
      document.getElementById("loadingIndicator").classList.remove("hidden");
      document.getElementById("submitBtn").disabled = true;
      
      // Przygotuj dane formularza
      const formData = new FormData(this);
      formData.append("timestamp", new Date().toISOString());
      
      try {
        // Wyślij dane do Google Apps Script Web App
        const response = await fetch('https://script.google.com/macros/s/AKfycbx3JRwjUzlxpKPdAXLQRm9PNHsnqwKuwVgifZdpJnJQH1epSq3tBazEbOmA35mR6fGDyw/exec', {
          method: 'POST',
          body: formData
        });
        
        // Pokaż komunikat sukcesu
        document.getElementById("successMessage").classList.remove("hidden");
        document.getElementById("incidentForm").reset();
        
        // Ukryj dodatkowe pola
        document.getElementById("poleIlosc").classList.add("hidden");
        document.getElementById("poleUszkodzenie").classList.add("hidden");
        document.getElementById("poleOpisZdjecia").classList.add("hidden");
        
        // Ukryj wskaźnik ładowania
        document.getElementById("loadingIndicator").classList.add("hidden");
        document.getElementById("submitBtn").disabled = false;
        
        // Ukryj komunikat sukcesu po 5 sekundach
        setTimeout(() => {
          document.getElementById("successMessage").classList.add("hidden");
        }, 5000);
        
      } catch (error) {
        console.error("Błąd podczas wysyłania zgłoszenia:", error);
        alert("Wystąpił błąd podczas wysyłania zgłoszenia. Spróbuj ponownie lub skontaktuj się z administratorem.");
        document.getElementById("loadingIndicator").classList.add("hidden");
        document.getElementById("submitBtn").disabled = false;
      }
    });

    // Załaduj listę kateringów przy starcie strony
    fetchKateringList();
  </script>
</body>
</html>
