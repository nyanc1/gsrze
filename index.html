<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zgłoszenie zdarzenia</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 1rem;
      margin: 0;
      background-color: #f8f9fa;
    }
    form {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
      color: #333;
    }
    label {
      display: block;
      margin-top: 1rem;
      color: #333;
      font-weight: 500;
    }
    input, select, textarea, datalist {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.25rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.75rem;
      font-size: 1rem;
      width: 100%;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background-color: #218838;
    }
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .hidden { display: none; }
    .loading {
      text-align: center;
      margin-top: 1rem;
    }
    .error {
      color: #dc3545;
      margin-top: 0.25rem;
      font-size: 0.875rem;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    .file-list {
      margin-top: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0.5rem;
      max-height: 150px;
      overflow-y: auto;
    }
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.25rem 0;
      border-bottom: 1px solid #eee;
    }
    .file-item:last-child {
      border-bottom: none;
    }
    .file-remove {
      color: #dc3545;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      margin: 0;
      width: auto;
    }
    .progress-container {
      width: 100%;
      background-color: #e9ecef;
      border-radius: 4px;
      margin-top: 1rem;
    }
    .progress-bar {
      height: 10px;
      background-color: #28a745;
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s;
    }
    .progress-text {
      text-align: center;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    .preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .preview-remove {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
    }
  </style>
</head>
<body>
  <form id="incidentForm">
    <h2>Zgłoszenie zdarzenia</h2>
    <div id="successMessage" class="success hidden">Zgłoszenie zostało wysłane pomyślnie!</div>

    <label>Miasto
      <input type="text" name="miasto" id="miasto" list="listaMiast" required>
      <datalist id="listaMiast"></datalist>
    </label>

    <label>Ulica
      <input type="text" name="ulica" id="ulica" list="listaUlic" required>
      <datalist id="listaUlic"></datalist>
    </label>

    <label>Nr domu / mieszkania
      <input type="text" name="numer" id="numer" required>
    </label>

    <label>Nazwa kateringu
      <select name="katering" id="katering" required>
        <option value="">-- Wybierz --</option>
      </select>
    </label>

    <label>Zdarzenie
      <select name="zdarzenie" id="zdarzenie" required>
        <option value="">-- Wybierz --</option>
        <option value="BRAK PACZKI">BRAK PACZKI</option>
        <option value="DODATKOWA PACZKA">DODATKOWA PACZKA</option>
        <option value="USZKODZENIE PACZKI">USZKODZENIE PACZKI</option>
        <option value="NIEDORECZENIE / BŁĘDNY ADRES">NIEDORECZENIE / BŁĘDNY ADRES</option>
      </select>
    </label>

    <div id="poleIlosc" class="hidden">
      <label>Ilość paczek
        <select name="ilosc" id="ilosc">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </label>
    </div>

    <div id="poleUszkodzenie" class="hidden">
      <label>Rodzaj uszkodzenia
        <select name="rodzaj_uszkodzenia" id="rodzaj_uszkodzenia">
          <option value="ROZSZCZELNIONY POJEMNIK">ROZSZCZELNIONY POJEMNIK</option>
          <option value="USZKODZONY POJEMNIK">USZKODZONY POJEMNIK</option>
        </select>
      </label>
      <label>
        Zdjęcia uszkodzeń (wymagane)
        <input type="file" name="zdjecia_uszkodzen" id="zdjecia_uszkodzen" accept="image/*" multiple>
      </label>
      <div id="previewUszkodzenia" class="preview-container"></div>
      <div id="fileListUszkodzenia" class="file-list hidden"></div>
    </div>

    <div id="poleOpisZdjecia" class="hidden">
      <label>Opis zdarzenia
        <textarea name="opis" id="opis" rows="4"></textarea>
      </label>
      <label>
        Zdjęcia / Film
        <input type="file" name="zdjecia_filmu" id="zdjecia_filmu" accept="image/*,video/*" multiple>
      </label>
      <div id="previewZdjeciaFilmu" class="preview-container"></div>
      <div id="fileListZdjeciaFilmu" class="file-list hidden"></div>
    </div>

    <div id="progressContainer" class="progress-container hidden">
      <div id="progressBar" class="progress-bar"></div>
      <div id="progressText" class="progress-text">0%</div>
    </div>

    <button type="submit" id="submitBtn">Wyślij zgłoszenie</button>
    <div id="loadingIndicator" class="loading hidden">
      Wysyłanie zgłoszenia, proszę czekać...
    </div>
  </form>

  <script>
    // Konfiguracja
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzMFpTTc-ov6BGIOm5uFcSxy_Mnn47XjiNHDKiKXvayOB4sH40hTj9wFSky30NaelPU/exec';
    const MAX_CHUNK_SIZE = 512 * 1024; // 512KB na fragment
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB maksymalny rozmiar pliku

    // Załaduj listę kateringów z pliku JSON
    async function fetchKateringList() {
      try {
        const response = await fetch('cateringlist.json');
        const data = await response.json();
        
        // Załaduj kateringi
        const select = document.getElementById("katering");
        select.innerHTML = '<option value="">-- Wybierz --</option>';
        
        data.caterings.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });
        
        // Załaduj miasta do datalisty
        const datalistMiasta = document.getElementById("listaMiast");
        datalistMiasta.innerHTML = '';
        data.miasta.forEach(miasto => {
          const option = document.createElement('option');
          option.value = miasto;
          datalistMiasta.appendChild(option);
        });
        
        // Załaduj ulice do datalisty
        const datalistUlice = document.getElementById("listaUlic");
        datalistUlice.innerHTML = '';
        data.ulice.forEach(ulica => {
          const option = document.createElement('option');
          option.value = ulica;
          datalistUlice.appendChild(option);
        });
      } catch (error) {
        console.error("Błąd podczas ładowania listy kateringów:", error);
        alert("Nie udało się załadować listy kateringów. Odśwież stronę lub skontaktuj się z administratorem.");
      }
    }

    // Obsługa plików i podglądu
    function setupFilePreview(inputId, previewContainerId) {
      const fileInput = document.getElementById(inputId);
      const previewContainer = document.getElementById(previewContainerId);
      
      fileInput.addEventListener('change', function() {
        previewContainer.innerHTML = '';
        
        if (this.files.length > 0) {
          Array.from(this.files).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
              const reader = new FileReader();
              
              reader.onload = function(e) {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                previewItem.appendChild(img);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'preview-remove';
                removeBtn.textContent = '×';
                removeBtn.addEventListener('click', function() {
                  // Nie można bezpośrednio usunąć pliku z FileList, więc trzeba będzie zresetować input
                  // i obsłużyć to na poziomie wysyłania
                  previewItem.remove();
                });
                previewItem.appendChild(removeBtn);
                
                previewContainer.appendChild(previewItem);
              };
              
              reader.readAsDataURL(file);
            } else if (file.type.startsWith('video/')) {
              // Dla filmów tworzymy specjalny placeholder
              const previewItem = document.createElement('div');
              previewItem.className = 'preview-item';
              previewItem.style.display = 'flex';
              previewItem.style.alignItems = 'center';
              previewItem.style.justifyContent = 'center';
              previewItem.style.backgroundColor = '#f8f9fa';
              
              const videoIcon = document.createElement('div');
              videoIcon.textContent = '🎬';
              videoIcon.style.fontSize = '24px';
              previewItem.appendChild(videoIcon);
              
              const removeBtn = document.createElement('button');
              removeBtn.className = 'preview-remove';
              removeBtn.textContent = '×';
              removeBtn.addEventListener('click', function() {
                previewItem.remove();
              });
              previewItem.appendChild(removeBtn);
              
              previewContainer.appendChild(previewItem);
            }
          });
        }
      });
    }

    // Obsługa zmiany rodzaju zdarzenia
    document.getElementById("zdarzenie").addEventListener("change", function() {
      const val = this.value;
      
      // Ukryj wszystkie pola dodatkowe
      document.getElementById("poleIlosc").classList.add("hidden");
      document.getElementById("poleUszkodzenie").classList.add("hidden");
      document.getElementById("poleOpisZdjecia").classList.add("hidden");
      
      // Resetuj wymagane pola
      document.getElementById("ilosc").removeAttribute("required");
      document.getElementById("rodzaj_uszkodzenia").removeAttribute("required");
      document.getElementById("zdjecia_uszkodzen").removeAttribute("required");
      document.getElementById("opis").removeAttribute("required");

      // Pokaż odpowiednie pola w zależności od wybranego zdarzenia
      if (val === "BRAK PACZKI" || val === "DODATKOWA PACZKA") {
        document.getElementById("poleIlosc").classList.remove("hidden");
        document.getElementById("ilosc").setAttribute("required", "");
      } else if (val === "USZKODZENIE PACZKI") {
        document.getElementById("poleUszkodzenie").classList.remove("hidden");
        document.getElementById("rodzaj_uszkodzenia").setAttribute("required", "");
        document.getElementById("zdjecia_uszkodzen").setAttribute("required", "");
      } else if (val === "NIEDORECZENIE / BŁĘDNY ADRES") {
        document.getElementById("poleOpisZdjecia").classList.remove("hidden");
        document.getElementById("opis").setAttribute("required", "");
      }
    });

    // Funkcja do podziału pliku na fragmenty
    function sliceFile(file, chunkSize) {
      const chunks = [];
      let start = 0;
      
      while (start < file.size) {
        const end = Math.min(start + chunkSize, file.size);
        chunks.push(file.slice(start, end));
        start = end;
      }
      
      return chunks;
    }

    // Funkcja do przesyłania pliku po kawałkach z obsługą CORS
    async function uploadFileInChunks(file, folderName, fieldName, onProgress) {
      if (file.size > MAX_FILE_SIZE) {
        throw new Error(`Plik ${file.name} jest za duży (maksymalnie ${MAX_FILE_SIZE / (1024 * 1024)}MB)`);
      }
      
      // Uzyskaj token sesji przed rozpoczęciem przesyłania
      const sessionResponse = await fetch(`${API_ENDPOINT}?action=initializeUpload`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          filename: file.name,
          mimeType: file.type,
          size: file.size,
          folderName: folderName,
          fieldName: fieldName
        }),
        mode: 'cors'
      });
      
      const sessionData = await sessionResponse.json();
      
      if (!sessionData.success) {
        throw new Error(`Nie udało się zainicjować sesji przesyłania: ${sessionData.error}`);
      }
      
      const sessionId = sessionData.sessionId;
      const chunks = sliceFile(file, MAX_CHUNK_SIZE);
      let uploadedChunks = 0;
      
      for (let i = 0; i < chunks.length; i++) {
        const chunk = chunks[i];
        const reader = new FileReader();
        
        // Użyj promise dla czytelności
        const chunkDataPromise = new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result.split(',')[1]); // Pobierz tylko dane base64
          reader.onerror = reject;
          reader.readAsDataURL(chunk);
        });
        
        const chunkData = await chunkDataPromise;
        
        // Wyślij fragment
        const chunkResponse = await fetch(`${API_ENDPOINT}?action=uploadChunk`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sessionId: sessionId,
            chunkIndex: i,
            totalChunks: chunks.length,
            data: chunkData
          }),
          mode: 'cors'
        });
        
        const chunkResult = await chunkResponse.json();
        
        if (!chunkResult.success) {
          throw new Error(`Błąd podczas przesyłania fragmentu ${i+1}/${chunks.length}: ${chunkResult.error}`);
        }
        
        uploadedChunks++;
        const progress = Math.round((uploadedChunks / chunks.length) * 100);
        onProgress(progress);
      }
      
      // Sfinalizuj przesyłanie
      const finalizeResponse = await fetch(`${API_ENDPOINT}?action=finalizeUpload`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          sessionId: sessionId
        }),
        mode: 'cors'
      });
      
      const finalizeResult = await finalizeResponse.json();
      
      if (!finalizeResult.success) {
        throw new Error(`Nie udało się sfinalizować przesyłania: ${finalizeResult.error}`);
      }
      
      return finalizeResult.fileUrl;
    }

    // Funkcja do przesyłania formularza
    async function submitForm(formData) {
      // Ustaw początkowe wartości dla paska postępu
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      document.getElementById('progressContainer').classList.remove('hidden');
      
      try {
        // Stwórz unikatową nazwę folderu dla tego zgłoszenia
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const folderName = `Zdarzenie_${timestamp}`;
        
        // Przygotuj dane podstawowe (bez plików)
        const formDataObj = {};
        for (const [key, value] of formData.entries()) {
          if (key !== 'zdjecia_uszkodzen' && key !== 'zdjecia_filmu') {
            formDataObj[key] = value;
          }
        }
        
        // Dodaj typ zdarzenia do danych
        formDataObj.zdarzenie_typ = formDataObj.zdarzenie;
        
        // Zainicjalizuj zgłoszenie z obsługą CORS
        progressText.textContent = 'Inicjalizacja zgłoszenia...';
        progressBar.style.width = '5%';
        
        const initResponse = await fetch(`${API_ENDPOINT}?action=initializeReport`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            folderName: folderName,
            formData: formDataObj
          }),
          mode: 'cors'
        });
        
        const initResult = await initResponse.json();
        
        if (!initResult.success) {
          throw new Error(`Nie udało się zainicjować zgłoszenia: ${initResult.error}`);
        }
        
        const reportId = initResult.reportId;
        progressBar.style.width = '10%';
        
        // Przesyłanie plików dla uszkodzeń
        const fileUrlsUszkodzenia = [];
        if (formDataObj.zdarzenie === 'USZKODZENIE PACZKI') {
          const files = document.getElementById('zdjecia_uszkodzen').files;
          let totalProgress = 0;
          
          for (let i = 0; i < files.length; i++) {
            progressText.textContent = `Przesyłanie zdjęcia ${i+1} z ${files.length}`;
            
            const fileUrl = await uploadFileInChunks(
              files[i], 
              folderName, 
              'zdjecia_uszkodzen',
              (progress) => {
                progressBar.style.width = `${10 + (progress * 0.8 / files.length) + (i * 80 / files.length)}%`;
                progressText.textContent = `Przesyłanie zdjęcia ${i+1} z ${files.length}: ${progress}%`;
              }
            );
            
            fileUrlsUszkodzenia.push(fileUrl);
            totalProgress = Math.round(((i + 1) / files.length) * 100);
          }
        }
        
        // Przesyłanie plików dla niedoręczonych paczek
        const fileUrlsFilmy = [];
        if (formDataObj.zdarzenie === 'NIEDORECZENIE / BŁĘDNY ADRES') {
          const files = document.getElementById('zdjecia_filmu').files;
          if (files.length > 0) {
            for (let i = 0; i < files.length; i++) {
              progressText.textContent = `Przesyłanie pliku ${i+1} z ${files.length}`;
              
              const fileUrl = await uploadFileInChunks(
                files[i], 
                folderName, 
                'zdjecia_filmu',
                (progress) => {
                  progressBar.style.width = `${10 + (progress * 0.8 / files.length) + (i * 80 / files.length)}%`;
                  progressText.textContent = `Przesyłanie pliku ${i+1} z ${files.length}: ${progress}%`;
                }
              );
              
              fileUrlsFilmy.push(fileUrl);
            }
          }
        }
        
        // Finalizacja zgłoszenia
        progressText.textContent = 'Finalizowanie zgłoszenia...';
        progressBar.style.width = '90%';
        
        const finalizeReportResponse = await fetch(`${API_ENDPOINT}?action=finalizeReport`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            reportId: reportId,
            fileUrlsUszkodzenia: fileUrlsUszkodzenia,
            fileUrlsFilmy: fileUrlsFilmy
          }),
          mode: 'cors'
        });
        
        const finalizeReportResult = await finalizeReportResponse.json();
        
        if (!finalizeReportResult.success) {
          throw new Error(`Nie udało się sfinalizować zgłoszenia: ${finalizeReportResult.error}`);
        }
        
        progressBar.style.width = '100%';
        progressText.textContent = 'Zgłoszenie zostało pomyślnie wysłane!';
        
        return finalizeReportResult;
        
      } catch (error) {
        console.error("Błąd podczas wysyłania formularza:", error);
        throw error;
      }
    }

    // Obsługa wysłania formularza
    document.getElementById("incidentForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      // Walidacja formularza
      const zdarzenie = document.getElementById("zdarzenie").value;
      
      if (zdarzenie === "USZKODZENIE PACZKI") {
        const zdjecia = document.getElementById("zdjecia_uszkodzen").files;
        if (zdjecia.length === 0) {
          alert("Dla uszkodzonej paczki wymagane jest załączenie zdjęć!");
          return;
        }
      }
      
      if (zdarzenie === "NIEDORECZENIE / BŁĘDNY ADRES") {
        const opis = document.getElementById("opis").value.trim();
        if (opis === "") {
          alert("Dla niedoręczonej paczki wymagany jest opis!");
          return;
        }
      }
      
      // Pokaż wskaźnik ładowania
      document.getElementById("loadingIndicator").classList.remove("hidden");
      document.getElementById("submitBtn").disabled = true;
      
      // Przygotuj dane formularza
      const formData = new FormData(this);
      formData.append("timestamp", new Date().toISOString());
      
      try {
        // Wyślij formularz
        const result = await submitForm(formData);
        
        // Pokaż komunikat sukcesu
        document.getElementById("successMessage").classList.remove("hidden");
        document.getElementById("incidentForm").reset();
        
        // Ukryj dodatkowe pola
        document.getElementById("poleIlosc").classList.add("hidden");
        document.getElementById("poleUszkodzenie").classList.add("hidden");
        document.getElementById("poleOpisZdjecia").classList.add("hidden");
        document.getElementById("progressContainer").classList.add("hidden");
        
        // Wyczyść podglądy
        document.getElementById("previewUszkodzenia").innerHTML = '';
        document.getElementById("previewZdjeciaFilmu").innerHTML = '';
        
        // Ukryj wskaźnik ładowania
        document.getElementById("loadingIndicator").classList.add("hidden");
        document.getElementById("submitBtn").disabled = false;
        
        // Ukryj komunikat sukcesu po 5 sekundach
        setTimeout(() => {
          document.getElementById("successMessage").classList.add("hidden");
        }, 5000);
        
      } catch (error) {
        console.error("Błąd podczas wysyłania zgłoszenia:", error);
        alert("Wystąpił błąd podczas wysyłania zgłoszenia: " + error.message);
        document.getElementById("progressContainer").classList.add("hidden");
        document.getElementById("loadingIndicator").classList.add("hidden");
        document.getElementById("submitBtn").disabled = false;
      }
    });

    // Inicjalizacja
    document.addEventListener('DOMContentLoaded', function() {
      // Załaduj listę kateringów
      fetchKateringList();
      
      // Skonfiguruj podgląd plików
      setupFilePreview('zdjecia_uszkodzen', 'previewUszkodzenia');
      setupFilePreview('zdjecia_filmu', 'previewZdjeciaFilmu');
    });
  </script>
</body>
</html>
